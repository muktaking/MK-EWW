#!/bin/bash

# Default values
usage="0"
temp="0"

# 1. Try Nvidia
if command -v nvidia-smi &> /dev/null; then
    # Grab data, ignore errors if GPU is asleep
    out=$(nvidia-smi --query-gpu=utilization.gpu,temperature.gpu --format=csv,noheader,nounits 2>/dev/null)
    if [ $? -eq 0 ] && [ -n "$out" ]; then
        usage=$(echo "$out" | cut -d',' -f1 | tr -d ' ')
        temp=$(echo "$out" | cut -d',' -f2 | tr -d ' ')
    fi
fi

# 2. Fallback to AMD/Integrated if Nvidia returned nothing
if [ "$usage" == "0" ] || [ -z "$usage" ]; then
    # Standard Linux paths for Integrated graphics
    usage=$(cat /sys/class/drm/card0/device/gpu_busy_percent 2>/dev/null || echo "0")
    temp=$(cat /sys/class/thermal/thermal_zone0/temp 2>/dev/null | awk '{print int($1/1000)}' || echo "0")
fi

# 3. FORCE non-empty values to prevent Eww JSON errors
[[ -z "$usage" ]] && usage="0"
[[ -z "$temp" ]] && temp="0"

echo "{\"usage\": \"$usage\", \"temp\": \"$temp\"}"
